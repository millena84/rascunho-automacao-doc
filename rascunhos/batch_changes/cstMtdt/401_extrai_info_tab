#!/bin/bash
# Script para extrair canal e formato e salvar em CSV com BOM e CRLF

set -e

CONFIG_FILE="./11_extract_org_metadata.json"
EXPORT_DIR="./1_metadados"
RAW_FILE="$EXPORT_DIR/saidaTerminal.txt"
OUTPUT_CSV="$EXPORT_DIR/_VincParCustom-CanalFormato.csv"

function info    { echo -e "\033[1;34m[INFO]\033[0m $1"; }
function success { echo -e "\033[1;32m[SUCCESS]\033[0m $1"; }
function error   { echo -e "\033[1;31m[ERROR]\033[0m $1"; }

info "ðŸš€ INICIANDO PROCESSO EXTRACAO (CONSULTA) TABELA REFERENCIA"
info "ðŸ•“ INICIO EXECUCAO: $(date '+%d/%m/%Y - %H:%M:%S')"

if [[ ! -f "$CONFIG_FILE" ]]; then
  error "âŒ Arquivo $CONFIG_FILE nÃ£o encontrado!"
  exit 1
fi

ORG_ALIAS_CONSULTA=$(node -e '
  try {
    const cfg = require("'"$CONFIG_FILE"'");
    if (!cfg.orgAliasRetrieve) throw new Error("orgAliasRetrieve ausente.");
    console.log(cfg.orgAliasRetrieve);
  } catch (e) {
    console.error("âŒ Erro ao ler orgAliasRetrieve:", e.message);
    process.exit(1);
  }
')

info "ðŸ”Ž AMBIENTE CONSULTADO (Org Alias): $ORG_ALIAS_CONSULTA"
mkdir -p "$EXPORT_DIR"

# Executa a query (sem alteraÃ§Ãµes)
sf data query \
  --query "QUERIE" \
  --target-org "$ORG_ALIAS_CONSULTA" > "$RAW_FILE"

info "âœ… Dados exportados com sucesso em: $RAW_FILE"
info "ðŸ” Convertendo resultado tabulado em CSV..."

# Grava cabeÃ§alho com BOM e CRLF
printf '\xEF\xBB\xBFCANAL;FORMATO\r\n' > "$OUTPUT_CSV"

# Converte com awk confiÃ¡vel (elimina linhas invÃ¡lidas e espaÃ§os)
tail -n +3 "$RAW_FILE" | grep -vE '^\+|^WM2_Canal_ID__r.Name' |
awk -F '|' 'NF >= 3 {
  canal=$2; formato=$3;
  gsub(/^[ \t]+|[ \t]+$/, "", canal);
  gsub(/^[ \t]+|[ \t]+$/, "", formato);
  if (canal != "" && formato != "") {
    printf "%s;%s\r\n", canal, formato;
  }
}' >> "$OUTPUT_CSV"

success "âœ… CSV gerado com sucesso: $OUTPUT_CSV"
